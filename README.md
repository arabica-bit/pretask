# KAKAOPAY PRE-TASK
---

> 과제 목적: 카카오페이의 머니 뿌리기 기능을 **'UI 및 메시지 영역은 제외한 간소화된 REST API'**로 구현.

## 개발 환경

- 기본 환경
    - IDE: IntelliJ IDEA Ultimate
    - OS: Mac OS X
    - GIT
- Server
    - Java8
    - Spring Boot 2.2.2
    - JPA
    - H2
    - Gradle
    - Junit5


## 빌드 및 실행하기
### 터미널 환경
- Git, Java 필요

```shell
$ git clone https://github.com/arabica-bit/pretask.git
$ cd pretask
$ ./gradlew clean build
$ java -jar build/libs/kakaopaytask-1.0-SNAPSHOT.jar
```

- BaseURL : `http://localhost:8080`

## 기능 요구사항
- 과제 목적: 카카오페이의 머니 뿌리기 기능을 **'UI 및 메시지 영역은 제외한 간소화된 REST API'**로 구현.
- 공통 사항
    - 뿌리기, 받기, 조회 기능을 수행하는 REST API를 구현한다.
    - 요청한 **사용자의 식별값은 숫자 형태**이며 `"X-USER-ID"` 라는 **HTTP Header**로 전달된다.
    - 요청한 사용자가 속한 **대화방의 식별값은 문자 형태**이며 `"X-ROOM-ID"` 라는 **HTTP Header**로 전달된다.
    - 모든 사용자는 뿌리기에 충분한 잔액을 보유하고 있다고 가정하여 별도로 **잔액에 관련된 체크는 하지 않음**.
    - 작성한 어플리케이션이 **다수의 서버에 다수의 인스턴스로 동작하더라도 기능에 문제가 없도록** 설계 할 것.
    - 각 기능 및 제약사항에 대한 **단위테스트**를 반드시 작성할 것.
- 작성할 API 목록
    1. 뿌리기 API 
    2. 받기 API
    3. 조회 API

## 개발 항목



#### 개요

| 이름   | URI                   | Method      | Parameter                                          |
| ------ | --------------------- | ----------- | -------------------------------------------------- |
| 뿌리기 | `/apis/spray/create`  | POST        | 뿌릴 금액 `int money` <br />뿌릴 인원 `int member` |
| 받기   | `/apis/spray/receive` | POST        | 뿌리기 토큰 `String token`                         |
| 조회   | `/apis/spray/status`  | GET         | 뿌리기 토큰 `String token`                         |
| 공통   |                       | HTTP Header | 헤더에 전달되는 `"X-USER-ID"`, `X-ROOM-ID` 포함.   |

#### 상세항목

* 뿌리기 API
  * 뿌릴 금액과 인원을 요청값으로 받는다.
  * 뿌리기 요청건에 대한 고유 token을 발급하고 응답값으로 내려준다.
  * 뿌릴 금액을 인원수에 맞게 분배하여 저장. 분배 로직은 자유롭게 구현.
  * token은 3자리 문자열로 구성되며 예측이 불가능해야 한다.
* 받기 API
  * 뿌리기에서 발급된 token을 요청값으로 받는다.
  * token에 해당하는 뿌리기 건 중 아직 누구에게도 할당되지 않은 분배건 하나를 API를 호출한 사용자에게 할당하고, 그 금액을 응답값으로 내려준다.
  * 뿌리기 당 한 사용자는 한번만 받을 수 있다.
  * 자신이 뿌리기 한 건은 자신이 받을 수 없다.
  * 뿌리기가 호출된 대화방과 동일한 대화방에 속한 사용자만 받을 수 있다.
  * 뿌린 건은 10분간만 유효. 뿌린지 10분이 지난 요청에 대해선 받기 실패 응답이 내려가야 한다.
* 조회 API
  * 뿌리기에서 발급된 token을 요청값으로 받는다.
  * token에 해당하는 뿌리기 건의 현재 상태를 응답값으로 내려준다.
  * 현재 상태는 "`뿌린 시각`, `뿌린 금액`, `받기 완료된 금액`, 받기 완료된 정보(`[받은 금액, 받은 사용자 아이디] 리스트`)"
  * 뿌리기를 생성한 사용자만 조회 할 수 있다. 다른 사람의 뿌리기 건이나 유효하지 않은 token 입력 시에는 조회 실패 응답이 내려가야 한다.
  * 뿌린 건에 대한 조회는 7일 동안 할 수 있다.
* 도메인
  - `SprayTak` : 뿌리기 실행에 대한 기본 정보를 담는다.
    - `Token` : 뿌리기 고유값
    - `Created` : 생성 일자
    - `Owner` : 생성한 소유자 정보
    - `Room` : 생성된 대화방
    - `Number` : 뿌릴 인원
    - `Seed` :  뿌릴 총 금액
  - `SprayChild` : 분할된 금액에 대한 정보를 담는다.
    - `Parent` : 뿌리기 고유값
    - `Amount` : 분할된 금액
    - `Who` : 받은 사람의 아이디

## 제약 사항 및 해결 방법

* 요청한 사용자의 식별값과 대화방은 HTTP Header로 전달.
  * `@RequestHeader`를 이용하여 처리.
* 뿌리기 API - token은 3자리 문자열로 구성되며 예측이 불가능해야 한다.
  * 한 자리마다 알파벳26개, 숫자10개, 특수문자9개 중에서 랜덤으로 선택하도록 구현.
  * 대화방 기존 생성된 token이 있으면 token을 새로 생성. 사용자가 속한 대화방 안에서는 유니크함을 보장.
* 뿌릴 금액을 인원수에 맞게 분배
  * 멤버 별로 최소 1원이상은 가질 수 있도록 분배
* 사용자 검사
  * 뿌리기 엔티티에 소유자(뿌리기를 생성한 사용자) 정보를 보관하여, 자신이 생성한 뿌리기는 받기 요청을 못하도록 검사.
  * 금액 엔티티에 받은 사람(금액 받기 완료한 사용자) 정보를 보관하여, 뿌리기 당 한번만 받을 수 있도록 검사.
* 시간 검사
  * `LocalDateTime`을 이용하여 현재 시간을 구하고, 비교할 수 있다.
  * `plusMinutes(int)`와 `plusDays(int)` 함수 이용하여 10분 혹은 7일 시간을 구하고, `isBefore(LocalDateTime)`를 통해 현재 시간과 비교한다.




